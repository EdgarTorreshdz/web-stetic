---
import { Icon } from "astro-icon/components"

interface Props {
  lang?: 'en' | 'es';
}

const { lang = "en" } = Astro.props;

const translations = {
  en: {
    aboutTitle: "About the treatment",
    aboutDescription: "We treat complex problems, such as the extraction of wisdom teeth and other interventions necessary for health.",
    list: [
      "Third molar surgery (wisdom teeth)",
      "Frenectomy",
      "Surgery for fractured or root-canaled teeth",
      "Impacted canine surgery",
      "Bone graft",
      "Sinus lift",
      "Implant placement"
    ],
    formCategory: "Surgery",
    formTitle: "Contact",
    formFirstName: "First Name",
    formLastName: "Last Name",
    formEmail: "Email",
    formPhone: "Phone Number",
    formSelectDefault: "Select a specialty",
    formPrivacy: "I accept the privacy notice",
    formButton: "Book an appointment",
    msgSuccess: "Your appointment has been successfully requested!",
    msgError: "An error occurred while sending your request.",
    msgNetwork: "Network error, please try again."
  },
  es: {
    aboutTitle: "Sobre el tratamiento",
    aboutDescription: "Tratamos problemas complejos, como la extracción de muelas del juicio y otras intervenciones necesarias para la salud.",
    list: [
      "Cirugía de terceros molares (muelas del juicio)",
      "Cirugía de frenillos",
      "Cirugía de dientes fracturados o endodonciados",
      "Cirugía de caninos impactado",
      "Injerto de hueso",
      "Elevación de seno",
      "Colocación de implantes"
    ],
    formCategory: "Cirugía",
    formTitle: "Contacto",
    formFirstName: "Nombre(s)",
    formLastName: "Apellidos",
    formEmail: "Correo electrónico",
    formPhone: "Número de teléfono",
    formSelectDefault: "Selecciona la especialidad",
    formPrivacy: "Acepto el aviso de privacidad",
    formButton: "Reservar una cita",
    msgSuccess: "¡Tu cita ha sido solicitada con éxito!",
    msgError: "Ocurrió un error al enviar tu solicitud.",
    msgNetwork: "Error de red, por favor inténtalo de nuevo."
  }
};

const t = translations[lang];

// Definición de especialidades para el select
const specialties = [
  { val: "Odontología General", en: "General Dentistry", es: "Odontología General" },
  { val: "Odontología Estetica", en: "Esthetic Dentistry", es: "Odontología Estética" },
  { val: "Endodoncia", en: "Endodontics", es: "Endodoncia" },
  { val: "Ortodoncia", en: "Orthodontics", es: "Ortodoncia" },
  { val: "Ortopedia", en: "Orthopedics", es: "Ortopedia" },
  { val: "Cirugia", en: "Surgery", es: "Cirugía" },
  { val: "Odontopediatria", en: "Pediatric Dentistry", es: "Odontopediatría" },
  { val: "Rehabilitación", en: "Rehabilitation", es: "Rehabilitación" },
];
---

<section class="about-especialidad">
  <div id="spinnerOverlay" class="spinner-overlay hidden">
    <div class="spinner"></div>
  </div>

  <div class="about-especialidad__grid" id="about">
    <div class="about-especialidad__column about-especialidad__column--content">
      <h2 class="about-especialidad__title">{t.aboutTitle}</h2>
      <img src="/cirugia.jpg" alt="Dental surgery" class="about-especialidad__image" />
      <p class="about-especialidad__text">{t.aboutDescription}</p>
      <ul class="about-especialidad__list">
        {t.list.map((item) => (
          <li class="about-especialidad__list-item">{item}</li>
        ))}
      </ul>
    </div>

    <div class="about-especialidad__column about-especialidad__column--form">
      <form id="contactForm" class="about-especialidad__form">
        <div class="about-especialidad__header">
          <p class="about-especialidad__header-text">{t.formCategory}</p>
          <h2 class="about-especialidad__header-text-title">{t.formTitle}</h2>
        </div>
        <input type="text" name="firstName" placeholder={t.formFirstName} required class="about-especialidad__form-input" />
        <input type="text" name="lastName" placeholder={t.formLastName} required class="about-especialidad__form-input" />
        <input type="email" name="email" placeholder={t.formEmail} required class="about-especialidad__form-input" />
        <input type="tel" name="phone" placeholder={t.formPhone} required class="about-especialidad__form-input" />
        
        <select name="treatment" required class="about-especialidad__form-select" style="color: #03192cb3;">
          <option value="" disabled selected>{t.formSelectDefault}</option>
          {specialties.map(spec => (
            <option value={spec.val}>{lang === 'es' ? spec.es : spec.en}</option>
          ))}
        </select>

        <div class="about-especialidad__form-checkbox-container">
          <input type="checkbox" name="privacy" id="privacy" required class="about-especialidad__form-checkbox" />
          <label for="privacy">{t.formPrivacy}</label>
        </div>

        <button type="submit" class="about-especialidad__form-button">
          {t.formButton}
          <Icon name="arrow" width="20" height="20" />
        </button>
        <div id="formMessage" class="form-message"></div>
      </form>
    </div>
  </div>
</section>

<script is:inline 
  data-success={t.msgSuccess} 
  data-error={t.msgError} 
  data-network={t.msgNetwork}>
  
  const form = document.getElementById('contactForm');
  const submitBtn = form.querySelector('button[type="submit"]');
  const msgEl = document.getElementById('formMessage');
  const spinner = document.getElementById('spinnerOverlay');
  
  // Obtenemos los mensajes traducidos del atributo data del script
  const scriptTag = document.currentScript;
  const msgSuccess = scriptTag.getAttribute('data-success');
  const msgError = scriptTag.getAttribute('data-error');
  const msgNetwork = scriptTag.getAttribute('data-network');

  form.addEventListener('submit', async e => {
    e.preventDefault();
    submitBtn.disabled = true;
    msgEl.textContent = '';
    msgEl.className = 'form-message';
    spinner.classList.remove('hidden');

    const payload = {
      firstName: form.firstName.value.trim(),
      lastName:  form.lastName.value.trim(),
      email:     form.email.value.trim(),
      phone:     form.phone.value.trim(),
      treatment: form.treatment.value,
      privacy:   form.privacy.checked,
    };

    try {
      const res = await fetch('https://correos-stetic-dental.onrender.com/send-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const json = await res.json();

      if (res.ok) {
        msgEl.textContent = msgSuccess;
        msgEl.classList.add('success');
        form.reset();
      } else {
        msgEl.textContent = json.error || msgError;
        msgEl.classList.add('error');
      }
    } catch {
      msgEl.textContent = msgNetwork;
      msgEl.classList.add('error');
    } finally {
      submitBtn.disabled = false;
      spinner.classList.add('hidden');
    }
  });
</script>

<style>
  /* Tus estilos se mantienen exactamente iguales */
  .about-especialidad { position: relative; max-width: 1200px; margin: 0 auto; width: 95%; }
  .about-especialidad__grid { display: grid; grid-template-columns: 1fr; gap: 20px; align-items: center; }
  @media screen and (min-width: 768px) { .about-especialidad__grid { grid-template-columns: 60% 40%; } }
  .about-especialidad__column { margin: 0; }
  .about-especialidad__column--form { display: flex; flex-direction: column; justify-content: center; }
  .about-especialidad__title { font-size: 30px; font-weight: bold; margin-bottom: 1rem; color: #382e27; text-align: center; }
  @media (min-width: 768px) { .about-especialidad__title { font-size: 42px; text-align: left; } }
  .about-especialidad__text { font-size: 16.9px; margin-bottom: 1rem; line-height: 1.5; }
  .about-especialidad__image { width: 100%; height: auto; margin-bottom: 1rem; }
  .about-especialidad__list { list-style: disc; padding-left: 1.5rem; margin-bottom: 1.5rem; }
  .about-especialidad__list-item { margin-bottom: 0.5rem; }
  .about-especialidad__header h2 { font-size: 1.8em; font-weight: 500; text-align: center; }
  .about-especialidad__header p { text-align: center; font-style: italic; text-transform: uppercase; font-size: 0.7em; letter-spacing: 0.2em; color: #382e27cc; }
  .about-especialidad__form { border: 1px solid #27B9C6; padding: 20px; display: flex; flex-direction: column; gap: 1rem; background-color: #faf8f6; }
  @media screen and (min-width: 768px) { .about-especialidad__form { padding: 5rem; } }
  .about-especialidad__form-input, .about-especialidad__form-select { outline: none; border: none; background-color: #faf8f6; border-bottom: 1px solid #27B9C6; border-radius: 4px; padding: 8px; min-height: 64px; font-size: 16px; box-sizing: border-box; }
  .about-especialidad__form-checkbox-container { display: flex; align-items: center; gap: 0.5rem; }
  .about-especialidad__form-button { padding: 1.5em 6.2em 1.5em 3em; font-weight: bold; border: none; cursor: pointer; border-radius: 4px; background-color: #27B9C6; color: #fff; transition: background-color 0.3s ease; margin-top: 20px; letter-spacing: 0.15em; text-transform: uppercase; font-size: 10.5px; display: flex; justify-content: space-between; align-items: center; }
  .about-especialidad__form-button:hover { background-color: #004080; }
  .spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; z-index: 1000; }
  .spinner-overlay.hidden { display: none !important; }
  .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #27B9C6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .form-message { margin-top: 1rem; font-size: 0.9rem; text-align: center; }
  .form-message.success { color: #006400; }
  .form-message.error { color: #8B0000; }
</style>